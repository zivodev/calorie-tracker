<head>
  <title>
    CalorieScope
  </title>
</head>




<form id="userForm" style="display:flex; flex-direction:column; gap:10px; max-width:300px; margin:auto;">
  <input type="number" id="age" placeholder="Age" required>
  <input type="number" id="weight" placeholder="Weight (kg)" required>
  <input type="number" id="height" placeholder="Height (cm)" required>

  <!-- ✅ Gender and activity stacked vertically -->
  <select id="gender" required>
    <option value="">Select Gender</option>
    <option value="male">Male</option>
    <option value="female">Female</option>
  </select>

  <select id="activity" required>
    <option value="">Activity Level</option>
    <option value="sedentary">Sedentary (little or no exercise)</option>
    <option value="light">Lightly Active (1–3 days/week)</option>
    <option value="moderate">Moderately Active (3–5 days/week)</option>
    <option value="active">Active (6–7 days/week)</option>
    <option value="very_active">Very Active (hard daily exercise)</option>
  </select>

  <button type="submit">----Scope----</button>
</form>

<div id="goal" style="margin-top:20px; text-align:center;"></div>
<div id="progressContainer" style="display:none; text-align:center; margin-top:20px;">
  <progress id="calorieBar" value="0" max="100" style="width:100%;"></progress>
  <p id="progressText">0 / 0 kcal</p>
  <input type="file" id="mealImage" accept="image/*">
  <button id="sendImage">Send Image</button>
</div>

<script>
let goal = 0;
let current = 0;

document.getElementById('userForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const data = {
    age: document.getElementById('age').value,
    weight: document.getElementById('weight').value,
    height: document.getElementById('height').value,
    gender: document.getElementById('gender').value,
    activity: document.getElementById('activity').value
  };

  try {
    const res = await fetch('https://zivodev.app.n8n.cloud/webhook/bcddd092-eaa8-4a52-9e24-a1a7e5b26dd6', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    const text = await res.text();
    console.log("Raw response:", text);

    let result;
    try {
      result = JSON.parse(text);
    } catch {
      console.error("JSON parse error");
      result = {};
    }

    goal = Number(result.dailyGoal) || 0;
    console.log("Goal value:", goal);

    document.getElementById('goal').textContent = `Your daily goal: ${goal} kcal`;
    document.getElementById('progressContainer').style.display = 'block';
    document.getElementById('calorieBar').max = goal;
    document.getElementById('progressText').textContent = `${current} / ${goal} kcal`;

  } catch (err) {
    console.error("Fetch error:", err);
  }
});

document.getElementById('sendImage').addEventListener('click', async () => {
  const file = document.getElementById('mealImage').files[0];
  if (!file) return alert('Upload an image first');

  const formData = new FormData();
  formData.append('image', file);
  formData.append('goal', goal);
  formData.append('current', current);

  const res = await fetch('https://YOUR-N8N-URL/webhook/meal-image', {
    method: 'POST',
    body: formData
  });

  const result = await res.json();
  const calories = Number(result.mealCalories) || 0;
  current += calories;

  document.getElementById('calorieBar').value = current;
  document.getElementById('progressText').textContent = `${current} / ${goal} kcal`;
});
</script>
